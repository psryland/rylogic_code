<?xml version="1.0" encoding="UTF-8"?>
<Wix
	xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<!--
	Notes:
	- This file can be compiled using the WiX tool kit tools: 'candle.exe' and 'light.exe'
	- This file is not set up to do both the RCT and RST because the GUIDs for each project
	  need to be unique. Using the same installer file would risk the same GUIDs being used.
	- Only the main executables are included explicitly in this file. The dlls and documentation
	  files are compiled into a separate file using the 'build_installer.py' script because I
	  don't want to have to remember to add new files to this script all the time. The executables
	  also have start menu and desktop shortcuts, so that's why they're in here.
	- This file should not need modifying unless the project folder structure is changed.
	- The 'build_installer.py' is set up to build the RST or RCT, it chooses which installer.wxs
	  file to use.
	- MSI installers only consider the first 3 version digits.
	  When creating a new installer make sure you increment at least the third digit.
	-->

	<?define ProjDir            = "."?> <!-- Updated by build_installer.py -->
	<?define Config             = "Release"?>
	<?define ProductName        = "Rex Config Tool" ?>
	<?define ProjectName        = "RexConfigTool" ?>
	<?define ProductVersion     = "1.0.0.0" ?> <!-- Updated by build_installer.py -->
	<?define ProductIcon        = "$(var.ProjDir)\logo.ico" ?>
	<?define Manufacturer       = "Rex Bionics" ?>
	<?define CompanyUrl         = "http://www.rexbionics.com" ?>
	<?define ProductDescription = "Service and Configuration Tool for the Rex Bionics mobility robot Rex" ?>
	<?define TargetDir          = "$(var.ProjDir)\bin\$(var.Config)"?>

	<!-- NEVER CHANGE THIS - it is required for upgrading existing installations -->
	<?define UpgradeCode = "6CE701CE-1E68-4BD3-BE87-13D3EC8AE9F5" ?>

	<Product
		Id="*"
		Name="$(var.ProductName)"
		Version="$(var.ProductVersion)"
		Manufacturer="$(var.Manufacturer)"
		UpgradeCode="$(var.UpgradeCode)"
		Language="1033"
		>

		<!-- Package description -->
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
		<MediaTemplate EmbedCab="yes"/>

		<!-- Installer icon -->
		<Icon Id="logo.ico" SourceFile="$(var.ProductIcon)"/>

		<!-- Override properties from the standard installer -->
		<Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
		<Property Id="ARPPRODUCTICON" Value="logo.ico"/>
		<Property Id="ARPHELPLINK" Value="$(var.CompanyUrl)"/>
		<Property Id="ARPURLINFOABOUT" Value="$(var.CompanyUrl)"/>
		<Property Id="DISABLEADVTSHORTCUTS" Value="1" /> <!-- needed to work around ICE errors for start menu and desktop shortcuts in perMachine installs -->

		<!-- Newer version installed message -->
		<MajorUpgrade DowngradeErrorMessage="A newer version of $(var.ProductName) is already installed." />

		<!-- Check that .net 4.5.2 is installed -->
		<PropertyRef Id="WIX_IS_NETFRAMEWORK_452_OR_LATER_INSTALLED"/>
		<Condition Message="This application requires .NET Framework 4.5.2. Please install the .NET Framework then run this installer again.">
			<![CDATA[Installed OR WIX_IS_NETFRAMEWORK_452_OR_LATER_INSTALLED]]>
		</Condition>
		
		<!-- Directories -->
		<Directory Id="TARGETDIR" Name="SourceDir">
			
			<!-- The install directory, in C:\program files (x86)\Rex Bionics Limited\Rex Service Tool-->
			<Directory Id="ProgramFilesFolder">
				<Directory Id="ManufacturerDir" Name="$(var.Manufacturer)">
					<Directory Id="INSTALLFOLDER" Name="$(var.ProductName)">
						<Directory Id="doc" Name="doc" />
						<Directory Id="lib" Name="lib">
							<Directory Id="lib_x86" Name="x86" />
							<Directory Id="lib_x64" Name="x64" />
						</Directory>
					</Directory>
				</Directory>
			</Directory>

			<!-- Start Menu folder -->
			<Directory Id="ProgramMenuFolder">
				<Directory Id="ProgramMenuVendorFolder" Name="$(var.Manufacturer)">
					<Directory Id="ProgramMenuProductFolder" Name="$(var.ProjectName)"/>
				</Directory>
			</Directory>

			<!-- Desktop shortcut -->
			<Directory Id="DesktopFolder" SourceName="Desktop"/>
		</Directory>

		<!-- This defines what is included in the MSI -->
		<Feature Id="ProductFeature" Title="$(var.ProjectName) Install" Level="1">
			<ComponentGroupRef Id="executables" />
			<ComponentGroupRef Id="binaries" />
			<ComponentGroupRef Id="binaries_x86" />
			<ComponentGroupRef Id="binaries_x64" />
			<ComponentGroupRef Id="doc_files" />
		</Feature>

		<!-- The main executables -->
		<ComponentGroup Id="executables">
			<Component Id="Cmp_ProjName" Directory="INSTALLFOLDER" Guid="*">
				<CreateFolder Directory="ProgramMenuVendorFolder"/>
				<CreateFolder Directory="ProgramMenuProductFolder"/>
				<File Id="File_ProjName" KeyPath="yes" Vital="yes" Source="$(var.TargetDir)\$(var.ProjectName).exe">
					<Shortcut Id="Lnk_StartMenuProjName" Directory="ProgramMenuProductFolder" Name="$(var.ProductName)" Description="$(var.ProductDescription)" Icon="logo.ico" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
					<Shortcut Id="Lnk_DesktopProjName" Directory="DesktopFolder" Name="$(var.ProductName)" Description="$(var.ProductDescription)" Icon="logo.ico" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
				</File>
				<!-- Don't remove 'ManufacturerDir' because this may not be the only RB product installed -->
				<RemoveFolder Id="Rm_INSTALLFOLDER" Directory="INSTALLFOLDER" On="uninstall"/>
				<RemoveFolder Id="Rm_ProgramMenuVendorFolder" Directory="ProgramMenuVendorFolder" On="uninstall" />
				<RemoveFolder Id="Rm_ProgramMenuProductFolder" Directory="ProgramMenuProductFolder" On="uninstall" />
				<RemoveFolder Id="Rm_DesktopFolder" Directory="DesktopFolder" On="uninstall" />
			</Component>
			<Component Id="Cmp_ConsoleServer" Directory="INSTALLFOLDER" Guid="*">
				<File Id="File_ConsoleServer" KeyPath="yes" Vital="yes" Source="$(var.ProjDir)\..\ConsoleServer\obj\v140\x86\Release\ConsoleServer.exe">
					<Shortcut Id="Lnk_StartMenuConsoleServer" Directory="ProgramMenuProductFolder" Name="Console Server" Description="Forwards Rex diagnostic console output to a TCP or COM port" Icon="logo.ico" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
				</File>
			</Component>
			<Component Id="Cmp_VRex" Directory="INSTALLFOLDER" Guid="*">
				<File Id="File_VRex" KeyPath="yes" Vital="yes" Source="$(var.TargetDir)\vrex_ui.exe" />
			</Component>
		</ComponentGroup>

		<!-- Properties of the installer dialogs -->
		<!-- See http://wixtoolset.org/documentation/manual/v3/wixui/wixui_customizations.html for image sizes -->
		<WixVariable Id="WixUILicenseRtf" Value="$(var.ProjDir)\..\..\resources\Licence.rtf" />
		<WixVariable Id="WixUIBannerBmp" Value="$(var.ProjDir)\..\..\resources\installer_banner_top.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="$(var.ProjDir)\..\..\resources\installer_banner_bkgd.bmp" />

		<UI>
			<UIRef Id="WixUI_InstallDir" />

			<!-- Skip license dialog -->
			<Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
			<Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>

			<!-- Launch after install -->
			<Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch $(var.ProductName)" />
			<Property Id="WixShellExecTarget" Value="[#File_ProjName]" />
			<Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
		</UI>

		<CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

	</Product>
</Wix>
